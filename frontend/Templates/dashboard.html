<!DOCTYPE html>
<html class="light dark" lang="es">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Dashboard de Estudiante - Asistencia Semanal</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='assets/imgs/Leon1.png') }}" />
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&amp;display=swap" rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#39E079",
                        "background-light": "#f6f8f7",
                        "background-dark": "#122017"
                    },
                    fontFamily: {
                        display: "Lexend"
                    },
                    borderRadius: {
                        DEFAULT: "0.25rem",
                        lg: "0.5rem",
                        xl: "0.75rem",
                        full: "9999px"
                    }
                }
            }
        };
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        .material-symbols-outlined.fill {
            font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        @keyframes pulse-ring {
            0% { transform: scale(0.95); opacity: 1; }
            50% { transform: scale(1); opacity: 0.7; }
            100% { transform: scale(0.95); opacity: 1; }
        }
        
        .pulse-ring {
            animation: pulse-ring 2s ease-in-out infinite;
        }
    </style>
</head>

<body class="font-display bg-background-light dark:bg-background-dark text-gray-800 dark:text-gray-200">
    <div class="flex min-h-screen">
        <aside
            class="w-20 lg:w-64 flex-shrink-0 bg-white dark:bg-background-dark dark:border-r dark:border-gray-800 flex flex-col transition-all duration-300">
            <div class="p-4 border-b border-gray-200 dark:border-gray-800">
                <div class="flex items-center gap-3 justify-center lg:justify-start">
                    <div class="size-10 rounded-full bg-primary/20 flex items-center justify-center text-primary text-sm font-bold border-2 border-primary/20">
                        {{ user.primer_nombre[0] }}{{ user.primer_apellido[0] }}
                    </div>
                    <div class="hidden lg:flex flex-col">
                        <h1 class="text-gray-900 dark:text-white text-base font-medium leading-normal">
                            {{ user.primer_nombre }} {{ user.primer_apellido }}
                        </h1>
                        <p class="text-gray-500 dark:text-gray-400 text-xs font-normal leading-normal">
                            {% if user.role == 'teacher' %}
                                Profesor
                            {% else %}
                                {{ user.career if user.career else '' }}
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
            <nav class="flex-1 px-2 py-4 space-y-1">
                <a class="flex items-center gap-3 px-3 py-2 rounded-lg bg-primary/10 text-primary dark:bg-primary/20"
                    href="#">
                    <span class="material-symbols-outlined fill">calendar_month</span>
                    <span class="hidden lg:inline text-sm font-medium">Mi Horario</span>
                </a>
                <a class="flex items-center gap-3 px-3 py-2 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg"
                    href="{{ url_for('front.historial_alumno') }}">
                    <span class="material-symbols-outlined">history</span>
                    <span class="hidden lg:inline text-sm font-medium">Historial</span>
                </a>
            </nav>
            <div class="px-2 py-4 mt-auto border-t border-gray-200 dark:border-gray-800">
                <a class="flex items-center gap-3 px-3 py-2 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg"
                    href="{{ url_for('front.configuracion') }}">
                    <span class="material-symbols-outlined">settings</span>
                    <span class="hidden lg:inline text-sm font-medium">Configuraci贸n</span>
                </a>
                <a class="flex items-center gap-3 px-3 py-2 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg mt-1"
                    href="{{ url_for('auth.logout') }}">
                    <span class="material-symbols-outlined">logout</span>
                    <span class="hidden lg:inline text-sm font-medium">Cerrar Sesi贸n</span>
                </a>
            </div>
        </aside>
        <main class="flex-1 p-4 lg:p-8 overflow-x-hidden">
            <div class="max-w-7xl mx-auto h-full flex flex-col">
                <header class="flex flex-wrap justify-between items-center gap-4 mb-8">
                    <div class="mb-8">
                        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Hola, {{ user.primer_nombre }}! </h1>
                        <p class="text-gray-500 dark:text-gray-400">
                            {% if user.role == 'teacher' %}
                                Profesor
                            {% else %}
                                Estudiante{% if user.career %} de {{ user.career }}{% endif %}
                            {% endif %}
                        </p>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="hidden sm:block text-right">
                            <p id="current-date" class="text-sm font-medium text-gray-900 dark:text-white"></p>
                            <p id="current-time" class="text-xs text-gray-500 dark:text-gray-400"></p>
                        </div>
                        <button
                            class="p-2 rounded-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-500 hover:text-primary transition-colors">
                            <span class="material-symbols-outlined">notifications</span>
                        </button>
                    </div>
                </header>
                <div class="flex-1 overflow-x-auto pb-4">
                    <div class="min-w-[1000px] grid grid-cols-5 gap-4">
                        {% for d in range(1,6) %}
                        <div class="flex flex-col gap-3 {% if d == today_index %}relative{% endif %}">
                            {% if d == today_index %}
                            <div
                                class="absolute -top-3 left-1/2 -translate-x-1/2 bg-primary text-white text-[10px] font-bold px-2 py-0.5 rounded-full z-10 uppercase tracking-tighter">
                                Hoy</div>
                            {% endif %}
                            <div
                                class="text-center py-2 border-b-2 {% if d == today_index %}border-primary mb-2 bg-primary/5 rounded-t-lg -mx-1{% else %}border-gray-200 dark:border-gray-800 mb-2{% endif %}">
                                <span
                                    class="block text-xs {% if d == today_index %}text-primary{% else %}text-gray-500 dark:text-gray-400{% endif %} uppercase font-bold">{{
                                    days_names[d] }}</span>
                                <span
                                    class="block text-lg font-semibold {% if d == today_index %}text-gray-900 dark:text-white{% else %}text-gray-400 dark:text-gray-600{% endif %}">{{
                                    week_dates[d] }}</span>
                            </div>

                            {% set day_courses = schedule.get(d, []) %}
                            {% if day_courses %}
                            {% for c in day_courses %}
                            <div class="glass-panel p-4 space-y-3 relative {% if c.can_mark %}border-2 border-primary shadow-lg shadow-primary/20{% else %}border border-gray-300 dark:border-gray-700{% endif %} rounded-xl" 
                                 data-course-day="{{ c.dia }}" 
                                 data-start-time="{{ c.start_time }}" 
                                 data-end-time="{{ c.end_time }}" 
                                 data-course-name="{{ c.name }}"
                                 data-notified="false">
                                {% if c.can_mark %}
                                <span class="absolute -top-2 -right-2 w-4 h-4 bg-primary rounded-full pulse-ring"></span>
                                {% endif %}
                                <div class="flex justify-between items-start">
                                    <span class="text-[10px] font-mono text-gray-500">{{ c.start_time }} - {{ c.end_time }}</span>
                                    {% if user.role == 'teacher' %}
                                    <button onclick="editarAula({{ c.id }}, '{{ c.aula or '' }}')" class="text-gray-400 hover:text-primary transition-colors">
                                        <span class="material-symbols-outlined text-lg">edit_location</span>
                                    </button>
                                    {% elif c.get('aula') %}
                                    <span class="material-symbols-outlined text-primary text-lg">location_on</span>
                                    {% endif %}
                                </div>
                                <h4 class="text-xs font-bold text-gray-900 dark:text-white">{{ c.name }}</h4>
                                <p id="aula-{{ c.id }}" class="text-[11px] text-gray-500 mt-1 flex items-center gap-1">
                                    {% if c.get('aula') %}
                                    <span class="material-symbols-outlined text-[14px]">location_on</span>
                                    Aula: {{ c.aula }}
                                    {% else %}
                                    <span class="material-symbols-outlined text-[14px]">location_off</span>
                                    Sin aula asignada
                                    {% endif %}
                                </p>
                                {% if c.can_mark %}
                                <div class="mt-2">
                                    {% if user.role == 'teacher' %}
                                    <div class="flex flex-col gap-3 mt-4">
                                        <button onclick="generarCodigo({{ c.id }}, this)" 
                                                class="w-full py-3 px-4 rounded-xl bg-primary text-background-dark font-bold text-sm hover:brightness-110 active:scale-[0.98] transition-all flex items-center justify-center gap-2 shadow-lg shadow-primary/20">
                                            <span class="material-symbols-outlined text-sm">key</span>
                                            Generar C贸digo
                                        </button>

                                        <a href="{{ url_for('front.ver_asistencia', course_id=c.id) }}" 
                                           class="w-full py-2 px-4 rounded-xl border border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-400 text-[11px] font-medium hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors flex items-center justify-center gap-2">
                                            <span class="material-symbols-outlined text-sm">group</span>
                                            Control de Alumnos
                                        </a>
                                        
                                        <a href="{{ url_for('front.ver_historial', course_id=c.id) }}" 
                                           class="w-full py-2 px-4 rounded-xl border border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-400 text-[11px] font-medium hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors flex items-center justify-center gap-2">
                                            <span class="material-symbols-outlined text-sm">history</span>
                                            Ver Historial
                                        </a>

                                        <div id="container-code-{{ c.id }}" class="hidden mt-2 p-3 rounded-xl bg-[#121C1F] border border-primary/30 animate-in fade-in zoom-in duration-300">
                                            <p class="text-[10px] text-primary uppercase font-bold text-center mb-1">C贸digo de Sesi贸n</p>
                                            <div class="flex items-center justify-between bg-black/20 rounded-lg p-2 border border-white/5">
                                                <span id="display-code-{{ c.id }}" class="text-xl font-mono font-bold text-white tracking-[0.3em] ml-2">------</span>
                                                <button onclick="copyToClipboard('{{ c.id }}')" class="p-2 text-gray-400 hover:text-primary transition-colors">
                                                    <span class="material-symbols-outlined text-sm">content_copy</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    {% elif user.role == 'student' %}
                                    <div class="flex flex-col gap-3 mt-4">
                                        <div class="space-y-1">
                                            <label for="code-{{ c.id }}" class="text-[10px] uppercase tracking-wider text-gray-500 font-bold ml-1">
                                                C贸digo de Clase
                                            </label>
                                            <input 
                                                id="code-{{ c.id }}" 
                                                type="text" 
                                                maxlength="6" 
                                                placeholder="000000" 
                                                class="w-full px-4 py-3 rounded-xl border-none bg-[#121C1F] text-gray-400 placeholder:text-gray-600 focus:ring-2 focus:ring-primary/50 transition-all text-center font-mono text-lg tracking-[0.2em]" 
                                            />
                                        </div>
                                        <button 
                                            onclick="enviarAsistencia({{ c.id }}, this)" 
                                            class="w-full py-3 px-4 rounded-xl bg-primary text-background-dark font-bold text-sm hover:brightness-110 active:scale-[0.98] transition-all flex items-center justify-center gap-2 shadow-lg shadow-primary/20"
                                        >
                                            <span class="material-symbols-outlined text-sm">verified_user</span>
                                            Validar Asistencia
                                        </button>
                                        <a 
                                            href="{{ url_for('front.cargar_justificativo') }}" 
                                            class="w-full py-2 px-4 rounded-xl border border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-400 text-[11px] font-medium hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors flex items-center justify-center gap-2"
                                        >
                                            <span class="material-symbols-outlined text-sm">description</span>
                                            Cargar Justificativo
                                        </a>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                            {% else %}
                            <div
                                class="border-2 border-dashed border-gray-200 dark:border-gray-800 rounded-xl p-8 flex items-center justify-center">
                                <span class="text-xs text-gray-400 text-center uppercase tracking-widest font-medium">No
                                    tienes materias este d铆a</span>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div
                    class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-800 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div
                        class="flex items-center gap-4 bg-white dark:bg-gray-900/50 p-4 rounded-xl border border-gray-100 dark:border-gray-800">
                        <div class="size-10 rounded-full bg-primary/10 flex items-center justify-center text-primary">
                            <span class="material-symbols-outlined">book</span>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 dark:text-gray-400">Materias Inscritas</p>
                            <p class="text-lg font-bold text-gray-900 dark:text-white">{{ course_count }}</p>
                        </div>
                    </div>
                    <div
                        class="flex items-center gap-4 bg-white dark:bg-gray-900/50 p-4 rounded-xl border border-gray-100 dark:border-gray-800">
                        <div
                            class="size-10 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center text-green-600 dark:text-green-400">
                            <span class="material-symbols-outlined">check_circle</span>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 dark:text-gray-400">Clases Asistidas</p>
                            <p class="text-lg font-bold text-gray-900 dark:text-white">{{ attended_count }} / {{ total_classes }}</p>
                        </div>
                    
            </div>
        </main>
    </div>

</body>

</html>

<script>
// Actualizar fecha y hora en tiempo real
function actualizarFechaHora() {
    const now = new Date();
    const dias = ['Domingo', 'Lunes', 'Martes', 'Mi茅rcoles', 'Jueves', 'Viernes', 'S谩bado'];
    const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
    
    const diaSemana = dias[now.getDay()];
    const dia = now.getDate();
    const mes = meses[now.getMonth()];
    
    let horas = now.getHours();
    const minutos = now.getMinutes().toString().padStart(2, '0');
    const ampm = horas >= 12 ? 'PM' : 'AM';
    horas = horas % 12 || 12;
    
    const fechaElement = document.getElementById('current-date');
    const horaElement = document.getElementById('current-time');
    
    if (fechaElement) fechaElement.textContent = `${diaSemana}, ${dia} de ${mes}`;
    if (horaElement) horaElement.textContent = `${horas}:${minutos} ${ampm}`;
}

function registrarAsistencia(courseId, btn){
    if(btn) btn.disabled = true;
    fetch('/auth/marcar_asistencia', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ course_id: courseId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            alert("隆Asistencia confirmada!");
            if(btn) btn.innerText = 'Registrado';
        } else {
            alert("Error: " + (data.error || 'Respuesta inesperada'));
            if(btn) btn.disabled = false;
        }
    })
    .catch(err => {
        alert('Error de red');
        if(btn) btn.disabled = false;
    });
}

function generarCodigo(courseId, btn) {
    if(btn) {
        btn.classList.add('opacity-50', 'pointer-events-none');
        btn.innerHTML = '<span class="animate-spin material-symbols-outlined text-sm">sync</span> Generando...';
    }

    fetch(`/auth/generate_code/${courseId}`, { method: 'POST' })
    .then(r => r.json())
    .then(data => {
        if(data.code) {
            const container = document.getElementById('container-code-' + courseId);
            const display = document.getElementById('display-code-' + courseId);
            
            if(container && display) {
                container.classList.remove('hidden');
                display.innerText = data.code;
            }
            
            if(btn) {
                btn.classList.remove('opacity-50', 'pointer-events-none');
                btn.innerHTML = '<span class="material-symbols-outlined text-sm">key</span> C贸digo Generado';
                btn.classList.replace('bg-primary', 'bg-gray-500');
            }
        } else {
            alert('Error: ' + (data.error || ''));
            if(btn) {
                btn.classList.remove('opacity-50', 'pointer-events-none');
                btn.innerHTML = '<span class="material-symbols-outlined text-sm">key</span> Generar C贸digo';
            }
        }
    }).catch(() => { 
        alert('Error de red');
        if(btn) {
            btn.classList.remove('opacity-50', 'pointer-events-none');
            btn.innerHTML = '<span class="material-symbols-outlined text-sm">key</span> Generar C贸digo';
        }
    });
}

function copyToClipboard(id) {
    const text = document.getElementById('display-code-' + id).innerText;
    navigator.clipboard.writeText(text).then(() => {
        alert('C贸digo copiado: ' + text);
    });
}

function enviarAsistencia(courseId, btn){
    const input = document.getElementById('code-' + courseId);
    const code = input ? input.value.trim() : '';
    if(!code){ alert('Ingresa el c贸digo'); return }
    if(btn) btn.disabled = true;
    fetch('/auth/submit_attendance', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ course_id: courseId, code: code })
    }).then(r => r.json())
    .then(data => {
        if(data.message){ alert('Asistencia registrada'); if(btn) btn.innerText='Registrado'; }
        else { alert('Error: ' + (data.error || '')); if(btn) btn.disabled=false; }
    }).catch(()=>{ alert('Error de red'); if(btn) btn.disabled=false; });
}

function guardarAsistenciaManual(courseId){
    const rows = document.querySelectorAll(`#table-${courseId} tr`);
    const attendance = [];
    rows.forEach(row => {
        const check = row.querySelector('.check-attendance');
        if(!check) return;
        attendance.push({ user_id: check.getAttribute('data-user-id'), state: check.checked ? 'Presente' : 'Ausente' });
    });

    fetch('/auth/bulk_attendance', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ course_id: courseId, attendance: attendance })
    })
    .then(r => r.json())
    .then(data => { if(data.message) alert(data.message); else alert('Error: ' + (data.error || '')) })
    .catch(()=> alert('Error de red'));
}

// Sistema de notificaciones
let notificationPermission = false;

function solicitarPermisoNotificaciones() {
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission().then(permission => {
            notificationPermission = (permission === 'granted');
        });
    } else if ('Notification' in window && Notification.permission === 'granted') {
        notificationPermission = true;
    }
}

function verificarClasesActivas() {
    const now = new Date();
    const currentDay = now.getDay() === 0 ? 7 : now.getDay(); // 1=Lunes, 7=Domingo
    const currentTime = now.getHours() * 60 + now.getMinutes();
    
    document.querySelectorAll('[data-course-day]').forEach(card => {
        const courseDay = parseInt(card.getAttribute('data-course-day'));
        const startTime = card.getAttribute('data-start-time');
        const endTime = card.getAttribute('data-end-time');
        const courseName = card.getAttribute('data-course-name');
        const notified = card.getAttribute('data-notified');
        
        if (courseDay === currentDay && startTime && endTime) {
            const [startH, startM] = startTime.split(':').map(Number);
            const [endH, endM] = endTime.split(':').map(Number);
            const startMinutes = startH * 60 + startM;
            const endMinutes = endH * 60 + endM;
            
            // Notificar cuando comienza la clase (dentro de los primeros 5 minutos)
            if (currentTime >= startMinutes && currentTime <= startMinutes + 5 && notified !== 'true') {
                if (notificationPermission) {
                    new Notification('隆Ya comenz贸 la clase!', {
                        body: `${courseName} - Ve a marcar tu asistencia`,
                        icon: '/static/assets/imgs/Leon1.png',
                        tag: 'class-start-' + courseName
                    });
                }
                // Mostrar alerta en pantalla tambi茅n
                mostrarAlertaClase(courseName);
                card.setAttribute('data-notified', 'true');
            }
            
            // Resetear notificaci贸n cuando termine la clase
            if (currentTime > endMinutes) {
                card.setAttribute('data-notified', 'false');
            }
        }
    });
}

function mostrarAlertaClase(courseName) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'fixed top-4 right-4 bg-primary text-background-dark px-6 py-4 rounded-xl shadow-2xl z-50 animate-bounce';
    alertDiv.innerHTML = `
        <div class="flex items-center gap-3">
            <span class="material-symbols-outlined text-2xl">notifications_active</span>
            <div>
                <p class="font-bold">隆Ya comenz贸 la clase!</p>
                <p class="text-sm">${courseName} - Ve a marcar tu asistencia</p>
            </div>
        </div>
    `;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.style.opacity = '0';
        alertDiv.style.transition = 'opacity 0.5s';
        setTimeout(() => alertDiv.remove(), 500);
    }, 8000);
}

// Inicializar al cargar la p谩gina
document.addEventListener('DOMContentLoaded', function() {
    actualizarFechaHora();
    setInterval(actualizarFechaHora, 1000);
    solicitarPermisoNotificaciones();
    verificarClasesActivas();
    // Verificar cada minuto
    setInterval(verificarClasesActivas, 60000);
});

function editarAula(courseId, aulaActual) {
    const nuevoAula = prompt('Ingresa el aula:', aulaActual);
    if (nuevoAula === null) return;
    
    fetch('/auth/actualizar_aula', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ course_id: courseId, aula: nuevoAula })
    })
    .then(r => r.json())
    .then(data => {
        if (data.message) {
            const aulaElement = document.getElementById('aula-' + courseId);
            if (aulaElement) {
                if (data.aula) {
                    aulaElement.innerHTML = '<span class="material-symbols-outlined text-[14px]">location_on</span> Aula: ' + data.aula;
                } else {
                    aulaElement.innerHTML = '<span class="material-symbols-outlined text-[14px]">location_off</span> Sin aula asignada';
                }
            }
            alert('Aula actualizada');
        } else {
            alert('Error: ' + (data.error || ''));
        }
    })
    .catch(() => alert('Error de red'));
}
</script>